# üí¨ SISTEMA DE MENSAJER√çA EN TIEMPO REAL - SERVITECH

## üöÄ Implementaci√≥n Completa con Socket.IO

### üìã Descripci√≥n General

El sistema de mensajer√≠a de SERVITECH proporciona comunicaci√≥n en tiempo real entre usuarios utilizando **Socket.IO**, **Express** y **MongoDB**. Permite conversaciones bidireccionales, notificaciones instant√°neas, indicadores de escritura y m√∫ltiples tipos de mensajes.

---

### üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND (Cliente)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ   Socket.IO     ‚îÇ  ‚îÇ   HTML/CSS/JS   ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ    Cliente      ‚îÇ  ‚îÇ   Interfaz UI   ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                    WebSocket / HTTP
                               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BACKEND (Servidor)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ   Socket.IO     ‚îÇ  ‚îÇ   Express.js    ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ    Servidor     ‚îÇ  ‚îÇ   API REST      ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ   Mongoose      ‚îÇ  ‚îÇ   Servicios     ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ   Modelos       ‚îÇ  ‚îÇ   Notificaciones‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                          MongoDB
                               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BASE DE DATOS                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ   Conversaciones‚îÇ  ‚îÇ    Mensajes     ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ    Usuarios     ‚îÇ  ‚îÇ  Notificaciones ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### üìÅ Estructura de Archivos

```
SERVITECH/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.js                          # Aplicaci√≥n principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socketMensajeriaService.js  # Servicio Socket.IO principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mensajeria.js               # Modelos de datos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ mensajeria.js               # Rutas API REST
‚îÇ   ‚îî‚îÄ‚îÄ package.json                        # Dependencias
‚îú‚îÄ‚îÄ test_mensajeria_completa.html           # Interfaz de prueba
‚îú‚îÄ‚îÄ test_mensajeria_sistema.sh              # Script de prueba automatizado
‚îî‚îÄ‚îÄ MENSAJERIA_IMPLEMENTACION.md            # Esta documentaci√≥n
```

---

### üîß Tecnolog√≠as Utilizadas

| Tecnolog√≠a | Versi√≥n | Prop√≥sito |
|------------|---------|-----------|
| **Socket.IO** | 4.8.1 | WebSockets en tiempo real |
| **Express.js** | 5.1.0 | Servidor web y API REST |
| **Mongoose** | 8.16.1 | ODM para MongoDB |
| **MongoDB** | 5.0+ | Base de datos NoSQL |
| **Node.js** | 16.0+ | Runtime de JavaScript |

---

### üöÄ Instalaci√≥n y Configuraci√≥n

#### 1. Prerequisitos
```bash
# Node.js 16.0 o superior
node --version

# npm o yarn
npm --version

# MongoDB corriendo
mongod --version
```

#### 2. Instalaci√≥n de Dependencias
```bash
cd backend
npm install
```

#### 3. Configuraci√≥n de Entorno
```bash
# Crear archivo .env
cat > .env << EOF
MONGODB_URI=mongodb://localhost:27017/servitech_mensajeria
PORT=3000
JWT_SECRET=tu_secreto_jwt_seguro
SOCKET_CORS_ORIGIN=*
EOF
```

#### 4. Iniciar el Sistema
```bash
# Modo desarrollo
npm run dev

# Modo producci√≥n
npm start
```

---

### üì° Eventos Socket.IO Disponibles

#### üîê Autenticaci√≥n

##### Cliente ‚Üí Servidor
```javascript
socket.emit('autenticar', {
    usuarioId: 'user123',
    token: 'jwt_token_aqui'
});
```

##### Servidor ‚Üí Cliente
```javascript
socket.on('autenticado', (data) => {
    console.log('Usuario autenticado:', data.usuarioId);
});
```

#### üí¨ Conversaciones

##### Unirse a Conversaci√≥n
```javascript
// Cliente ‚Üí Servidor
socket.emit('unirse_conversacion', {
    conversacionId: 'conv_123'
});

// Servidor ‚Üí Cliente
socket.on('unido_conversacion', (data) => {
    console.log('Unido a:', data.conversacionId);
    console.log('Participantes:', data.participantes_conectados);
});
```

##### Salir de Conversaci√≥n
```javascript
socket.emit('salir_conversacion', {
    conversacionId: 'conv_123'
});
```

#### üì§ Mensajes

##### Enviar Mensaje
```javascript
socket.emit('enviar_mensaje', {
    conversacionId: 'conv_123',
    contenido: {
        texto: 'Hola, ¬øc√≥mo est√°s?',
        tipo: 'texto',
        archivo: null, // Para archivos
        metadatos: {} // Datos adicionales
    },
    tipo: 'texto', // texto, imagen, archivo, audio
    respuestaA: 'mensaje_id', // Opcional: responder a otro mensaje
    prioridad: 'normal' // normal, alta, urgente
});
```

##### Recibir Mensaje
```javascript
socket.on('nuevo_mensaje', (data) => {
    console.log('Nuevo mensaje:', data.mensaje);
    console.log('Conversaci√≥n:', data.conversacionId);
});
```

##### Confirmar Env√≠o
```javascript
socket.on('mensaje_enviado', (data) => {
    console.log('Mensaje enviado:', data.mensajeId);
    console.log('Estado:', data.estado);
});
```

#### üëÅÔ∏è Estados de Lectura

##### Marcar como Le√≠do
```javascript
// Mensaje espec√≠fico
socket.emit('marcar_leido', {
    mensajeId: 'msg_123',
    conversacionId: 'conv_123'
});

// Todos los mensajes de una conversaci√≥n
socket.emit('marcar_leido', {
    conversacionId: 'conv_123'
});
```

##### Notificaci√≥n de Lectura
```javascript
socket.on('mensaje_leido', (data) => {
    console.log('Mensaje le√≠do por:', data.leidoPor);
    console.log('Mensaje ID:', data.mensajeId);
});
```

#### ‚úèÔ∏è Indicador de Escritura

```javascript
// Mostrar que est√° escribiendo
socket.emit('escribiendo', {
    conversacionId: 'conv_123',
    escribiendo: true
});

// Dejar de escribir
socket.emit('escribiendo', {
    conversacionId: 'conv_123',
    escribiendo: false
});

// Recibir notificaci√≥n de escritura
socket.on('usuario_escribiendo', (data) => {
    if (data.escribiendo) {
        console.log(`${data.usuarioId} est√° escribiendo...`);
    } else {
        console.log(`${data.usuarioId} dej√≥ de escribir`);
    }
});
```

#### ‚≠ê Reacciones

```javascript
// Agregar reacci√≥n
socket.emit('agregar_reaccion', {
    mensajeId: 'msg_123',
    tipo: 'like' // like, love, laugh, surprise, sad
});

// Recibir reacci√≥n
socket.on('reaccion_agregada', (data) => {
    console.log('Nueva reacci√≥n:', data.reacciones);
});
```

#### üîî Estados de Conexi√≥n

```javascript
// Usuario conectado
socket.on('usuario_conectado', (data) => {
    console.log('Usuario conectado:', data.usuarioId);
});

// Usuario desconectado
socket.on('usuario_desconectado', (data) => {
    console.log('Usuario desconectado:', data.usuarioId);
});

// Estado general de usuario
socket.on('estado_usuario_cambiado', (data) => {
    console.log('Estado cambiado:', data.usuarioId, data.conectado);
});
```

#### üîß Mantenimiento de Conexi√≥n

```javascript
// Ping/Pong para mantener conexi√≥n activa
socket.emit('ping');

socket.on('pong', (data) => {
    console.log('Conexi√≥n activa:', data.timestamp);
});
```

#### ‚ùå Manejo de Errores

```javascript
socket.on('error', (error) => {
    console.error('Error:', error.message);
    // Manejar diferentes tipos de errores
    switch(error.code) {
        case 'AUTH_REQUIRED':
            // Redirigir a login
            break;
        case 'PERMISSION_DENIED':
            // Mostrar mensaje de permisos
            break;
        default:
            // Error gen√©rico
            break;
    }
});
```

---

### üóÑÔ∏è Modelos de Datos

#### Conversaci√≥n
```javascript
{
    _id: ObjectId,
    codigoConversacion: String, // CONV-1234567890-ABC123
    participantes: [{
        usuario: ObjectId, // Referencia a Usuario
        rol: String, // cliente, experto, moderador, admin
        fechaIngreso: Date,
        activo: Boolean,
        ultimaConexion: Date,
        enLinea: Boolean,
        permisos: {
            puedeEnviar: Boolean,
            puedeEliminar: Boolean,
            puedeModerar: Boolean
        }
    }],
    asesoria: ObjectId, // Opcional: referencia a asesor√≠a
    tipo: String, // individual, grupal, soporte
    configuracion: {
        nombrePersonalizado: String,
        descripcion: String,
        avatar: String,
        configuracionPrivacidad: Object,
        notificacionesActivas: Boolean
    },
    estadisticas: {
        totalMensajes: Number,
        ultimoMensaje: Date,
        mensajesNoLeidos: Map
    },
    activa: Boolean,
    fechaCreacion: Date,
    fechaUltimaActividad: Date
}
```

#### Mensaje
```javascript
{
    _id: ObjectId,
    conversacion: ObjectId, // Referencia a Conversaci√≥n
    remitente: ObjectId, // Referencia a Usuario
    contenido: {
        texto: String,
        tipo: String, // texto, imagen, archivo, audio, video
        archivo: {
            nombre: String,
            url: String,
            tamano: Number,
            tipo: String
        },
        metadatos: Object // Datos adicionales seg√∫n tipo
    },
    respuestaA: ObjectId, // Referencia a otro mensaje
    prioridad: String, // normal, alta, urgente
    estado: String, // enviado, entregado, leido, fallido
    fechaEnvio: Date,
    fechaEntrega: Date,
    lecturas: [{
        usuario: ObjectId,
        fechaLectura: Date
    }],
    reacciones: [{
        usuario: ObjectId,
        tipo: String, // like, love, laugh, surprise, sad
        fecha: Date
    }],
    editado: {
        editado: Boolean,
        fechaEdicion: Date,
        historial: Array
    },
    socketInfo: {
        socketId: String,
        ipAddress: String,
        userAgent: String
    }
}
```

---

### üß™ Pruebas del Sistema

#### 1. Prueba Automatizada
```bash
# Ejecutar script de prueba completo
./test_mensajeria_sistema.sh
```

#### 2. Interfaz de Prueba Web
```bash
# Abrir test_mensajeria_completa.html en navegador
open test_mensajeria_completa.html
```

#### 3. Pruebas Manuales con curl

##### Verificar servidor activo
```bash
curl http://localhost:3000/
```

##### Probar endpoint de mensajer√≠a
```bash
curl -X GET http://localhost:3000/api/mensajeria/test
```

#### 4. Cliente de Prueba Program√°tico

```javascript
const io = require('socket.io-client');

const socket = io('http://localhost:3000');

// Flujo completo de prueba
socket.on('connect', () => {
    console.log('Conectado');
    
    // 1. Autenticar
    socket.emit('autenticar', {
        usuarioId: 'test_user',
        token: 'test_token'
    });
});

socket.on('autenticado', () => {
    // 2. Unirse a conversaci√≥n
    socket.emit('unirse_conversacion', {
        conversacionId: 'conv_test'
    });
});

socket.on('unido_conversacion', () => {
    // 3. Enviar mensaje
    socket.emit('enviar_mensaje', {
        conversacionId: 'conv_test',
        contenido: { texto: 'Hola mundo!' },
        tipo: 'texto'
    });
});

socket.on('nuevo_mensaje', (data) => {
    console.log('Mensaje recibido:', data.mensaje.contenido.texto);
    socket.disconnect();
});
```

---

### üìä Monitoreo y M√©tricas

#### Estad√≠sticas en Tiempo Real
```javascript
// Desde el servicio
const stats = socketMensajeriaService.obtenerEstadisticas();
console.log(stats);
/*
{
    usuariosConectados: 25,
    conversacionesActivas: 12,
    totalSockets: 25,
    timestamp: "2025-07-06T10:30:00.000Z"
}
*/
```

#### Logs del Sistema
```bash
# Ver logs en tiempo real
tail -f backend/server.log

# Filtrar logs de Socket.IO
grep "Socket.IO" backend/server.log
```

---

### üîí Seguridad y Autenticaci√≥n

#### 1. Validaci√≥n de JWT (Recomendado para Producci√≥n)
```javascript
// En socketMensajeriaService.js
const jwt = require('jsonwebtoken');

socket.on('autenticar', async (data) => {
    try {
        const { token } = data;
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        const usuarioId = decoded.userId;
        
        // Continuar con autenticaci√≥n...
    } catch (error) {
        socket.emit('error', { message: 'Token inv√°lido' });
    }
});
```

#### 2. Validaci√≥n de Permisos
```javascript
// Verificar permisos antes de enviar mensaje
const conversacion = await Conversacion.findById(conversacionId);
const participante = conversacion.participantes.find(p => 
    p.usuario.toString() === usuarioId
);

if (!participante || !participante.permisos.puedeEnviar) {
    socket.emit('error', { message: 'Sin permisos para enviar' });
    return;
}
```

#### 3. Rate Limiting
```javascript
// Implementar l√≠mite de mensajes por minuto
const userMessageCount = new Map();

socket.on('enviar_mensaje', async (data) => {
    const userId = socket.usuarioId;
    const now = Date.now();
    const userMessages = userMessageCount.get(userId) || [];
    
    // Filtrar mensajes del √∫ltimo minuto
    const recentMessages = userMessages.filter(time => 
        now - time < 60000
    );
    
    if (recentMessages.length >= 10) {
        socket.emit('error', { 
            message: 'L√≠mite de mensajes excedido' 
        });
        return;
    }
    
    // Agregar timestamp del mensaje actual
    recentMessages.push(now);
    userMessageCount.set(userId, recentMessages);
    
    // Continuar con env√≠o del mensaje...
});
```

---

### üöÄ Despliegue en Producci√≥n

#### 1. Variables de Entorno Producci√≥n
```bash
# .env.production
NODE_ENV=production
PORT=3000
MONGODB_URI=mongodb://usuario:password@host:27017/servitech_prod
JWT_SECRET=secreto_muy_seguro_de_produccion
SOCKET_CORS_ORIGIN=https://tusitio.com,https://app.tusitio.com
REDIS_URL=redis://localhost:6379  # Para clustering
```

#### 2. Configuraci√≥n de CORS Estricta
```javascript
// En app.js
const corsOptions = {
    origin: process.env.NODE_ENV === 'production' 
        ? ['https://tusitio.com', 'https://app.tusitio.com']
        : '*',
    credentials: true
};

app.use(cors(corsOptions));

// Socket.IO CORS
socketMensajeriaService.inicializar(server, {
    cors: corsOptions
});
```

#### 3. Clustering para Escalabilidad
```javascript
// cluster.js
const cluster = require('cluster');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
    for (let i = 0; i < numCPUs; i++) {
        cluster.fork();
    }
    
    cluster.on('exit', (worker) => {
        console.log(`Worker ${worker.process.pid} muri√≥`);
        cluster.fork();
    });
} else {
    require('./src/app.js');
}
```

#### 4. Docker Configuration
```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  servitech-backend:
    build: .
    ports:
      - "3000:3000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017/servitech
    depends_on:
      - mongo
      
  mongo:
    image: mongo:5.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

volumes:
  mongo_data:
```

---

### üîß Troubleshooting

#### Problemas Comunes

##### 1. Error: "Cannot connect to Socket.IO server"
```bash
# Verificar que el servidor est√© corriendo
curl http://localhost:3000/socket.io/

# Verificar logs del servidor
tail -f backend/server.log
```

##### 2. Error: "Usuario no autenticado"
```javascript
// Asegurarse de autenticar antes de usar el socket
socket.on('connect', () => {
    socket.emit('autenticar', {
        usuarioId: 'tu_usuario_id',
        token: 'tu_jwt_token'
    });
});
```

##### 3. Mensajes no se entregan
```javascript
// Verificar que est√©s unido a la conversaci√≥n
socket.emit('unirse_conversacion', {
    conversacionId: 'tu_conversacion_id'
});

// Verificar eventos de error
socket.on('error', (error) => {
    console.error('Error:', error);
});
```

##### 4. Conexi√≥n se pierde frecuentemente
```javascript
// Implementar reconexi√≥n autom√°tica
socket.on('disconnect', () => {
    console.log('Desconectado, intentando reconectar...');
    setTimeout(() => {
        socket.connect();
    }, 5000);
});
```

---

### üìà Optimizaciones y Mejoras Futuras

#### 1. Redis para Clustering
```javascript
// Usar Redis adapter para m√∫ltiples instancias
const { createAdapter } = require('@socket.io/redis-adapter');
const { createClient } = require('redis');

const pubClient = createClient({ url: process.env.REDIS_URL });
const subClient = pubClient.duplicate();

io.adapter(createAdapter(pubClient, subClient));
```

#### 2. Compresi√≥n de Mensajes
```javascript
// Configurar compresi√≥n en Socket.IO
const io = new Server(server, {
    compression: true,
    httpCompression: true
});
```

#### 3. Persistencia de Sesiones
```javascript
// Guardar datos de sesi√≥n en Redis
const session = require('express-session');
const RedisStore = require('connect-redis')(session);

app.use(session({
    store: new RedisStore({ client: redisClient }),
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false
}));
```

#### 4. Notificaciones Push
```javascript
// Integrar con Firebase Cloud Messaging
const admin = require('firebase-admin');

const enviarNotificacionPush = async (usuarioId, mensaje) => {
    const token = await obtenerTokenFCM(usuarioId);
    
    const message = {
        data: {
            title: 'Nuevo mensaje',
            body: mensaje.contenido.texto
        },
        token: token
    };
    
    await admin.messaging().send(message);
};
```

---

### üìû Soporte y Contacto

Para m√°s informaci√≥n sobre la implementaci√≥n o soporte t√©cnico:

- **Documentaci√≥n**: Este archivo
- **C√≥digo fuente**: `/backend/src/services/socketMensajeriaService.js`
- **Pruebas**: `test_mensajeria_completa.html`
- **Script de prueba**: `test_mensajeria_sistema.sh`

---

### üìù Changelog

#### v1.0.0 (6 de julio de 2025)
- ‚úÖ Implementaci√≥n inicial completa
- ‚úÖ Socket.IO configurado
- ‚úÖ Modelos de datos MongoDB
- ‚úÖ Eventos b√°sicos de mensajer√≠a
- ‚úÖ Autenticaci√≥n de usuarios
- ‚úÖ Indicadores de escritura
- ‚úÖ Sistema de reacciones
- ‚úÖ Interfaz de prueba web
- ‚úÖ Script de prueba automatizado
- ‚úÖ Documentaci√≥n completa

---

### üéØ Conclusi√≥n

El sistema de mensajer√≠a de SERVITECH est√° **completamente implementado y funcional**. Proporciona una base s√≥lida para comunicaci√≥n en tiempo real con todas las caracter√≠sticas modernas esperadas en una aplicaci√≥n de mensajer√≠a profesional.

**üöÄ Sistema listo para producci√≥n con escalabilidad y mantenibilidad en mente.**
